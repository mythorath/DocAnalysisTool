<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Documents - Railway</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .search-result {
            border-left: 4px solid #667eea;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .search-result:hover {
            border-left-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .snippet {
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .highlight {
            background-color: #ffeb3b;
            font-weight: bold;
        }
        .status-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .search-tips {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Status Badge -->
    <div class="status-badge">
        <span class="badge bg-success">
            <i class="fas fa-cloud"></i> Railway Cloud
        </span>
    </div>

    <!-- Search Header -->
    <section class="search-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-search"></i> Search Documents
                    </h1>
                    <p class="lead mb-0">
                        Search through processed documents with full-text capabilities
                    </p>
                </div>
                <div class="col-lg-4 text-end">
                    <a href="/" class="btn btn-light">
                        <i class="fas fa-upload"></i> Upload More Documents
                    </a>
                </div>
            </div>
        </div>
    </section>

    <div class="container my-5">
        <!-- Search Form -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control" id="searchQuery" 
                                       placeholder="Enter your search query..." required>
                                <button class="btn btn-primary" type="submit" id="searchBtn">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb"></i>
                                    Try: "fiscal year", "payment AND medicare", or "budget OR funding"
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" id="statusCard">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" id="statusSpinner"></div>
                            <span id="statusText">Checking system status...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="searchResults" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 id="resultsHeader">Search Results</h4>
                        <span class="badge bg-primary" id="resultCount">0 results</span>
                    </div>
                    <div id="resultsList"></div>
                </div>
            </div>
        </div>

        <!-- No Results -->
        <div id="noResults" style="display: none;">
            <div class="text-center p-5">
                <i class="fas fa-search" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
                <h4>No Results Found</h4>
                <p class="text-muted">Try adjusting your search terms or upload more documents.</p>
            </div>
        </div>

        <!-- Loading -->
        <div id="searchLoading" style="display: none;">
            <div class="text-center p-5">
                <div class="spinner-border text-primary mb-3"></div>
                <h4>Searching...</h4>
                <p class="text-muted">Please wait while we search through your documents.</p>
            </div>
        </div>

        <!-- Search Tips -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="search-tips p-4">
                    <h5><i class="fas fa-info-circle"></i> Search Tips</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><strong>Phrase search:</strong> "exact phrase"</li>
                                <li><strong>Boolean AND:</strong> term1 AND term2</li>
                                <li><strong>Boolean OR:</strong> term1 OR term2</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><strong>Boolean NOT:</strong> term1 NOT term2</li>
                                <li><strong>Wildcard:</strong> term* (partial matches)</li>
                                <li><strong>Single terms:</strong> Just type what you're looking for</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check system status on load
        checkStatus();

        // Search form handler
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            performSearch();
        });

        function checkStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusCard = document.getElementById('statusCard');
                    const statusSpinner = document.getElementById('statusSpinner');
                    const statusText = document.getElementById('statusText');
                    
                    statusSpinner.style.display = 'none';
                    
                    if (data.ready_for_search) {
                        statusCard.className = 'card border-success';
                        statusText.innerHTML = `
                            <i class="fas fa-check-circle text-success"></i>
                            Ready for search! ${data.documents_processed} documents processed.
                        `;
                    } else {
                        statusCard.className = 'card border-warning';
                        statusText.innerHTML = `
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            No documents processed yet. Please upload documents first.
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('statusSpinner').style.display = 'none';
                    document.getElementById('statusText').innerHTML = `
                        <i class="fas fa-times-circle text-danger"></i>
                        Error checking status: ${error.message}
                    `;
                });
        }

        function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) return;

            // Show loading
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';

            fetch('/api/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    limit: 50
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('searchLoading').style.display = 'none';
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.results && data.results.length > 0) {
                    displayResults(data);
                } else {
                    document.getElementById('noResults').style.display = 'block';
                }
            })
            .catch(error => {
                document.getElementById('searchLoading').style.display = 'none';
                alert('Search error: ' + error.message);
            });
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('searchResults');
            const resultsHeader = document.getElementById('resultsHeader');
            const resultCount = document.getElementById('resultCount');
            const resultsList = document.getElementById('resultsList');

            resultsHeader.textContent = `Search Results for "${data.query}"`;
            resultCount.textContent = `${data.total_results} result${data.total_results === 1 ? '' : 's'}`;

            let html = '';
            data.results.forEach((result, index) => {
                html += `
                    <div class="card search-result">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-file-alt text-primary"></i>
                                    ${result.filename || 'Document'}
                                </h5>
                                <span class="badge bg-secondary">Rank: ${result.rank || (index + 1)}</span>
                            </div>
                            ${result.source ? `<p class="text-muted small mb-2"><strong>Source:</strong> ${result.source}</p>` : ''}
                            ${result.snippet ? `
                                <div class="snippet p-3 rounded">
                                    <strong>Excerpt:</strong><br>
                                    ${result.snippet}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            resultsList.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>
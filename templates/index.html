{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-cloud me-3"></i>
                Public Comment Analysis Tool
            </h1>
            <p class="lead text-muted">
                Cloud-powered document analysis for public comment processing
            </p>
        </div>

        <!-- Step 1: Upload CSV -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Step 1: Upload CSV File
                </h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <div id="uploadContent">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Drop your CSV file here or click to browse</h5>
                        <p class="text-muted">
                            CSV must contain columns: "Document ID" and "URL"<br>
                            Maximum file size: 500MB
                        </p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose File
                        </button>
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="text-muted">Uploading and validating...</p>
                    </div>
                </div>
                
                <div id="fileInfo" style="display: none;" class="mt-3">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>File Validated Successfully</h6>
                        <div id="fileDetails"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Start Analysis -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-play me-2"></i>
                    Step 2: Start Analysis
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    The analysis will download documents, extract text, build a search index, and perform clustering analysis.
                </p>
                <button id="startAnalysis" class="btn btn-success btn-lg" disabled>
                    <i class="fas fa-rocket me-2"></i>
                    Start Full Analysis
                </button>
            </div>
        </div>

        <!-- Step 3: Monitor Progress -->
        <div id="progressSection" style="display: none;" class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    Analysis Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="job-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Analysis Job</h6>
                        <span id="jobStatus" class="status-indicator status-running">Running</span>
                    </div>
                    
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    
                    <div id="progressMessage" class="text-muted">
                        Initializing...
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div id="resultsSection" style="display: none;" class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="resultsSummary"></div>
                
                <div class="mt-3">
                    <a href="{{ url_for('search') }}" class="btn btn-primary me-2">
                        <i class="fas fa-search me-2"></i>Search Documents
                    </a>
                    <button id="downloadResults" class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Download Results
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentJobId = null;
let uploadedFile = null;

// File upload handling
document.getElementById('csvFile').addEventListener('change', handleFileUpload);

// Drag and drop
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileUpload({ target: { files: files } });
    }
});

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a CSV file');
        return;
    }

    // Show upload progress
    document.getElementById('uploadContent').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'block';

    const formData = new FormData();
    formData.append('csv_file', file);

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('uploadProgress').style.display = 'none';
        
        if (data.success) {
            uploadedFile = data.filename;
            showFileInfo(data);
            document.getElementById('startAnalysis').disabled = false;
        } else {
            alert('Upload failed: ' + data.error);
            document.getElementById('uploadContent').style.display = 'block';
        }
    })
    .catch(error => {
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadContent').style.display = 'block';
        alert('Upload failed: ' + error.message);
    });
}

function showFileInfo(data) {
    const details = `
        <strong>File:</strong> ${data.filename}<br>
        <strong>Documents:</strong> ${data.document_count}<br>
        <strong>Columns:</strong> ${data.columns.join(', ')}
    `;
    document.getElementById('fileDetails').innerHTML = details;
    document.getElementById('fileInfo').style.display = 'block';
}

// Start analysis
document.getElementById('startAnalysis').addEventListener('click', () => {
    if (!uploadedFile) {
        alert('Please upload a CSV file first');
        return;
    }

    fetch('/start_analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            csv_file: uploadedFile
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.job_id) {
            currentJobId = data.job_id;
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('startAnalysis').disabled = true;
            monitorJob();
        } else {
            alert('Failed to start analysis: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Failed to start analysis: ' + error.message);
    });
});

function monitorJob() {
    if (!currentJobId) return;

    fetch(`/job_status/${currentJobId}`)
    .then(response => response.json())
    .then(data => {
        updateProgress(data);
        
        if (data.status === 'completed') {
            showResults(data);
        } else if (data.status === 'failed') {
            showError(data.message);
        } else {
            // Continue monitoring
            setTimeout(monitorJob, 2000);
        }
    })
    .catch(error => {
        console.error('Error monitoring job:', error);
        setTimeout(monitorJob, 5000);
    });
}

function updateProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const progressMessage = document.getElementById('progressMessage');
    const jobStatus = document.getElementById('jobStatus');

    progressBar.style.width = data.progress + '%';
    progressMessage.textContent = data.message;

    if (data.status === 'completed') {
        jobStatus.textContent = 'Completed';
        jobStatus.className = 'status-indicator status-completed';
        progressBar.className = 'progress-bar bg-success';
    } else if (data.status === 'failed') {
        jobStatus.textContent = 'Failed';
        jobStatus.className = 'status-indicator status-failed';
        progressBar.className = 'progress-bar bg-danger';
    }
}

function showResults(data) {
    const summary = data.results?.summary;
    if (summary) {
        const summaryHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Analysis Summary</h6>
                    <ul class="list-unstyled">
                        <li><strong>Total Documents:</strong> ${summary.total_documents}</li>
                        <li><strong>Successful Extractions:</strong> ${summary.successful_extractions}</li>
                        <li><strong>Text Files Processed:</strong> ${summary.text_files_processed}</li>
                        <li><strong>Completed:</strong> ${new Date(summary.analysis_date).toLocaleString()}</li>
                    </ul>
                </div>
            </div>
        `;
        document.getElementById('resultsSummary').innerHTML = summaryHtml;
    }
    
    document.getElementById('resultsSection').style.display = 'block';
    
    // Setup download button
    document.getElementById('downloadResults').onclick = () => {
        window.location.href = `/download_results/${currentJobId}`;
    };
}

function showError(message) {
    const errorHtml = `
        <div class="alert alert-danger">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Analysis Failed</h6>
            <p class="mb-0">${message}</p>
        </div>
    `;
    document.getElementById('resultsSummary').innerHTML = errorHtml;
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('startAnalysis').disabled = false;
}
</script>
{% endblock %}
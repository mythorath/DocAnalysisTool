{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-cloud me-3"></i>
                Public Comment Analysis Tool
            </h1>
            <p class="lead text-success">
                <i class="fas fa-rocket me-2"></i>
                Powered by Vercel
            </p>
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Vercel Demo Version</h6>
                <p class="mb-0">
                    This is a demonstration version with limited processing (100 documents max, 10MB files).
                    <br>For full functionality, deploy to Railway, DigitalOcean, or other platforms.
                </p>
            </div>
        </div>

        <!-- Step 1: Upload CSV -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Step 1: Upload CSV File (Demo: Max 100 docs, 10MB)
                </h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <div id="uploadContent">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Drop your CSV file here or click to browse</h5>
                        <p class="text-muted">
                            CSV must contain columns: "Document ID" and "URL"<br>
                            <strong>Vercel limits:</strong> Max 100 documents, 10MB file size
                        </p>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('csvFile').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose File
                        </button>
                    </div>
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="text-muted">Uploading and validating...</p>
                    </div>
                </div>
                
                <div id="fileInfo" style="display: none;" class="mt-3">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>File Validated Successfully</h6>
                        <div id="fileDetails"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Quick Analysis -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-zap me-2"></i>
                    Step 2: Quick Analysis (Demo Version)
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Demo Limitations</h6>
                    <ul class="mb-0">
                        <li>File type detection only (no full text extraction)</li>
                        <li>First 10 documents processed</li>
                        <li>Files over 5MB skipped</li>
                        <li>No OCR or clustering analysis</li>
                    </ul>
                </div>
                <p class="text-muted">
                    This demo will analyze your CSV and detect document types.
                </p>
                <button id="startQuickAnalysis" class="btn btn-warning btn-lg" disabled>
                    <i class="fas fa-bolt me-2"></i>
                    Start Quick Analysis (Demo)
                </button>
            </div>
        </div>

        <!-- Step 3: Results -->
        <div id="resultsSection" style="display: none;" class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="resultsSummary"></div>
            </div>
        </div>

        <!-- Step 4: Full Deployment -->
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-rocket me-2"></i>
                    Step 3: Deploy Full Version
                </h5>
            </div>
            <div class="card-body">
                <h6>Ready for full document processing?</h6>
                <p class="text-muted">
                    Deploy the complete version with OCR, clustering, and unlimited document processing.
                </p>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-success">Railway.app</h6>
                                <p class="small text-muted">Free tier, easy deployment</p>
                                <a href="https://railway.app/new/template?template=your-repo" class="btn btn-success btn-sm">
                                    Deploy to Railway
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6 class="text-info">DigitalOcean</h6>
                                <p class="small text-muted">$5/month, reliable</p>
                                <a href="{{ url_for('deployment_guide') }}" class="btn btn-info btn-sm">
                                    Deployment Guide
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h6 class="text-warning">Google Cloud</h6>
                                <p class="small text-muted">Pay-per-use</p>
                                <a href="{{ url_for('deployment_guide') }}" class="btn btn-warning btn-sm">
                                    Learn More
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let uploadedFile = null;

// File upload handling
document.getElementById('csvFile').addEventListener('change', handleFileUpload);

// Drag and drop
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileUpload({ target: { files: files } });
    }
});

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a CSV file');
        return;
    }

    // Check file size for Vercel
    if (file.size > 10 * 1024 * 1024) {
        alert('File too large for Vercel demo (max 10MB). Use full deployment for larger files.');
        return;
    }

    // Show upload progress
    document.getElementById('uploadContent').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'block';

    const formData = new FormData();
    formData.append('csv_file', file);

    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('uploadProgress').style.display = 'none';
        
        if (data.success) {
            uploadedFile = data.filename;
            showFileInfo(data);
            document.getElementById('startQuickAnalysis').disabled = false;
        } else {
            alert('Upload failed: ' + data.error);
            document.getElementById('uploadContent').style.display = 'block';
        }
    })
    .catch(error => {
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadContent').style.display = 'block';
        alert('Upload failed: ' + error.message);
    });
}

function showFileInfo(data) {
    const details = `
        <strong>File:</strong> ${data.filename}<br>
        <strong>Documents:</strong> ${data.document_count}<br>
        <strong>Columns:</strong> ${data.columns.join(', ')}<br>
        ${data.platform_note ? `<strong>Note:</strong> ${data.platform_note}` : ''}
    `;
    document.getElementById('fileDetails').innerHTML = details;
    document.getElementById('fileInfo').style.display = 'block';
}

// Start quick analysis
document.getElementById('startQuickAnalysis').addEventListener('click', () => {
    if (!uploadedFile) {
        alert('Please upload a CSV file first');
        return;
    }

    document.getElementById('startQuickAnalysis').disabled = true;
    document.getElementById('startQuickAnalysis').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';

    fetch('/quick_analysis', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            csv_file: uploadedFile
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.results) {
            showResults(data);
        } else {
            alert('Analysis failed: ' + (data.error || 'Unknown error'));
        }
        document.getElementById('startQuickAnalysis').disabled = false;
        document.getElementById('startQuickAnalysis').innerHTML = '<i class="fas fa-bolt me-2"></i>Start Quick Analysis (Demo)';
    })
    .catch(error => {
        alert('Analysis failed: ' + error.message);
        document.getElementById('startQuickAnalysis').disabled = false;
        document.getElementById('startQuickAnalysis').innerHTML = '<i class="fas fa-bolt me-2"></i>Start Quick Analysis (Demo)';
    });
});

function showResults(data) {
    const results = data.results;
    
    let resultHtml = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Quick Analysis Complete</h6>
            <p class="mb-0">Analyzed ${results.length} documents from your CSV</p>
        </div>
        
        <h6>Document Detection Results:</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Document ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    results.forEach(result => {
        const statusClass = result.status === 'detected' ? 'success' : 
                          result.status === 'skipped' ? 'warning' : 'danger';
        const statusIcon = result.status === 'detected' ? 'check-circle' : 
                         result.status === 'skipped' ? 'exclamation-triangle' : 'times-circle';
        
        resultHtml += `
            <tr>
                <td>${result.document_id}</td>
                <td><span class="badge bg-primary">${result.type || 'Unknown'}</span></td>
                <td><i class="fas fa-${statusIcon} text-${statusClass}"></i> ${result.status}</td>
                <td class="small text-muted">${result.note || result.reason || result.error || ''}</td>
            </tr>
        `;
    });
    
    resultHtml += `
                </tbody>
            </table>
        </div>
        
        <div class="alert alert-info mt-3">
            <h6><i class="fas fa-info-circle me-2"></i>Next Steps</h6>
            <p class="mb-0">
                This demo detected your document types. For full text extraction, OCR processing, 
                search indexing, and clustering analysis, deploy the complete version using the 
                deployment options below.
            </p>
        </div>
    `;
    
    document.getElementById('resultsSummary').innerHTML = resultHtml;
    document.getElementById('resultsSection').style.display = 'block';
}
</script>
{% endblock %}